function r(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function a(r){return!!r.constructor&&"function"==typeof r.constructor.isBuffer&&r.constructor.isBuffer(r)}var s=function(r){for(var a=new Array(r),s=0;s<r;++s)a[s]=s;return a},t=function(r){return null!=r&&(a(r)||function(r){return"function"==typeof r.readFloatLE&&"function"==typeof r.slice&&a(r.slice(0,0))}(r)||!!r._isBuffer)},e="undefined"!=typeof Float64Array;function n(r,a){return r[0]-a[0]}function o(){var r,a=this.stride,s=new Array(a.length);for(r=0;r<s.length;++r)s[r]=[Math.abs(a[r]),r];s.sort(n);var t=new Array(s.length);for(r=0;r<t.length;++r)t[r]=s[r][1];return t}function i(r,a){var t=["View",a,"d",r].join("");a<0&&(t="View_Nil"+r);var e="generic"===r;if(-1===a){var n="function "+t+"(a){this.data=a;};var proto="+t+".prototype;proto.dtype='"+r+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+t+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+t+"(a){return new "+t+"(a);}";return new Function(n)()}if(0===a){n="function "+t+"(a,d) {this.data = a;this.offset = d};var proto="+t+".prototype;proto.dtype='"+r+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+t+"_copy() {return new "+t+"(this.data,this.offset)};proto.pick=function "+t+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+t+"_get(){return "+(e?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+t+"_set(v){return "+(e?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+t+"(a,b,c,d){return new "+t+"(a,d)}";return new Function("TrivialArray",n)(h[r][0])}n=["'use strict'"];var i=s(a),u=i.map(function(r){return"i"+r}),l="this.offset+"+i.map(function(r){return"this.stride["+r+"]*i"+r}).join("+"),c=i.map(function(r){return"b"+r}).join(","),f=i.map(function(r){return"c"+r}).join(",");n.push("function "+t+"(a,"+c+","+f+",d){this.data=a","this.shape=["+c+"]","this.stride=["+f+"]","this.offset=d|0}","var proto="+t+".prototype","proto.dtype='"+r+"'","proto.dimension="+a),n.push("Object.defineProperty(proto,'size',{get:function "+t+"_size(){return "+i.map(function(r){return"this.shape["+r+"]"}).join("*"),"}})"),1===a?n.push("proto.order=[0]"):(n.push("Object.defineProperty(proto,'order',{get:"),a<4?(n.push("function "+t+"_order(){"),2===a?n.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):3===a&&n.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):n.push("ORDER})")),n.push("proto.set=function "+t+"_set("+u.join(",")+",v){"),e?n.push("return this.data.set("+l+",v)}"):n.push("return this.data["+l+"]=v}"),n.push("proto.get=function "+t+"_get("+u.join(",")+"){"),e?n.push("return this.data.get("+l+")}"):n.push("return this.data["+l+"]}"),n.push("proto.index=function "+t+"_index(",u.join(),"){return "+l+"}"),n.push("proto.hi=function "+t+"_hi("+u.join(",")+"){return new "+t+"(this.data,"+i.map(function(r){return["(typeof i",r,"!=='number'||i",r,"<0)?this.shape[",r,"]:i",r,"|0"].join("")}).join(",")+","+i.map(function(r){return"this.stride["+r+"]"}).join(",")+",this.offset)}");var p=i.map(function(r){return"a"+r+"=this.shape["+r+"]"}),d=i.map(function(r){return"c"+r+"=this.stride["+r+"]"});n.push("proto.lo=function "+t+"_lo("+u.join(",")+"){var b=this.offset,d=0,"+p.join(",")+","+d.join(","));for(var g=0;g<a;++g)n.push("if(typeof i"+g+"==='number'&&i"+g+">=0){d=i"+g+"|0;b+=c"+g+"*d;a"+g+"-=d}");n.push("return new "+t+"(this.data,"+i.map(function(r){return"a"+r}).join(",")+","+i.map(function(r){return"c"+r}).join(",")+",b)}"),n.push("proto.step=function "+t+"_step("+u.join(",")+"){var "+i.map(function(r){return"a"+r+"=this.shape["+r+"]"}).join(",")+","+i.map(function(r){return"b"+r+"=this.stride["+r+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(g=0;g<a;++g)n.push("if(typeof i"+g+"==='number'){d=i"+g+"|0;if(d<0){c+=b"+g+"*(a"+g+"-1);a"+g+"=ceil(-a"+g+"/d)}else{a"+g+"=ceil(a"+g+"/d)}b"+g+"*=d}");n.push("return new "+t+"(this.data,"+i.map(function(r){return"a"+r}).join(",")+","+i.map(function(r){return"b"+r}).join(",")+",c)}");var y=new Array(a),_=new Array(a);for(g=0;g<a;++g)y[g]="a[i"+g+"]",_[g]="b[i"+g+"]";n.push("proto.transpose=function "+t+"_transpose("+u+"){"+u.map(function(r,a){return r+"=("+r+"===undefined?"+a+":"+r+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+t+"(this.data,"+y.join(",")+","+_.join(",")+",this.offset)}"),n.push("proto.pick=function "+t+"_pick("+u+"){var a=[],b=[],c=this.offset");for(g=0;g<a;++g)n.push("if(typeof i"+g+"==='number'&&i"+g+">=0){c=(c+this.stride["+g+"]*i"+g+")|0}else{a.push(this.shape["+g+"]);b.push(this.stride["+g+"])}");return n.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),n.push("return function construct_"+t+"(data,shape,stride,offset){return new "+t+"(data,"+i.map(function(r){return"shape["+r+"]"}).join(",")+","+i.map(function(r){return"stride["+r+"]"}).join(",")+",offset)}"),new Function("CTOR_LIST","ORDER",n.join("\n"))(h[r],o)}var h={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};var u=r(function(r,a,s,n){if(void 0===r)return(0,h.array[0])([]);"number"==typeof r&&(r=[r]),void 0===a&&(a=[r.length]);var o=a.length;if(void 0===s){s=new Array(o);for(var u=o-1,l=1;u>=0;--u)s[u]=l,l*=a[u]}if(void 0===n){n=0;for(u=0;u<o;++u)s[u]<0&&(n-=(a[u]-1)*s[u])}for(var c=function(r){if(t(r))return"buffer";if(e)switch(Object.prototype.toString.call(r)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(r)?"array":"generic"}(r),f=h[c];f.length<=o+1;)f.push(i(c,f.length-1));return(0,f[o+1])(r,a,s,n)}),l={};var c=function(r,a,s){return 0===r.length?r:a?(s||r.sort(a),function(r,a){for(var s=1,t=r.length,e=r[0],n=r[0],o=1;o<t;++o)if(n=e,a(e=r[o],n)){if(o===s){s++;continue}r[s++]=e}return r.length=s,r}(r,a)):(s||r.sort(),function(r){for(var a=1,s=r.length,t=r[0],e=r[0],n=1;n<s;++n,e=t)if(e=t,(t=r[n])!==e){if(n===a){a++;continue}r[a++]=t}return r.length=a,r}(r))};function f(r,a,s){var t,e,n=r.length,o=a.arrayArgs.length,i=a.indexArgs.length>0,h=[],u=[],l=0,c=0;for(t=0;t<n;++t)u.push(["i",t,"=0"].join(""));for(e=0;e<o;++e)for(t=0;t<n;++t)c=l,l=r[t],0===t?u.push(["d",e,"s",t,"=t",e,"p",l].join("")):u.push(["d",e,"s",t,"=(t",e,"p",l,"-s",c,"*t",e,"p",c,")"].join(""));for(u.length>0&&h.push("var "+u.join(",")),t=n-1;t>=0;--t)l=r[t],h.push(["for(i",t,"=0;i",t,"<s",l,";++i",t,"){"].join(""));for(h.push(s),t=0;t<n;++t){for(c=l,l=r[t],e=0;e<o;++e)h.push(["p",e,"+=d",e,"s",t].join(""));i&&(t>0&&h.push(["index[",c,"]-=s",c].join("")),h.push(["++index[",l,"]"].join(""))),h.push("}")}return h.join("\n")}function p(r,a,s){for(var t=r.body,e=[],n=[],o=0;o<r.args.length;++o){var i=r.args[o];if(!(i.count<=0)){var h=new RegExp(i.name,"g"),u="",l=a.arrayArgs.indexOf(o);switch(a.argTypes[o]){case"offset":var c=a.offsetArgIndex.indexOf(o);l=a.offsetArgs[c].array,u="+q"+c;case"array":u="p"+l+u;var f="l"+o,p="a"+l;if(0===a.arrayBlockIndices[l])1===i.count?"generic"===s[l]?i.lvalue?(e.push(["var ",f,"=",p,".get(",u,")"].join("")),t=t.replace(h,f),n.push([p,".set(",u,",",f,")"].join(""))):t=t.replace(h,[p,".get(",u,")"].join("")):t=t.replace(h,[p,"[",u,"]"].join("")):"generic"===s[l]?(e.push(["var ",f,"=",p,".get(",u,")"].join("")),t=t.replace(h,f),i.lvalue&&n.push([p,".set(",u,",",f,")"].join(""))):(e.push(["var ",f,"=",p,"[",u,"]"].join("")),t=t.replace(h,f),i.lvalue&&n.push([p,"[",u,"]=",f].join("")));else{for(var d=[i.name],g=[u],y=0;y<Math.abs(a.arrayBlockIndices[l]);y++)d.push("\\s*\\[([^\\]]+)\\]"),g.push("$"+(y+1)+"*t"+l+"b"+y);if(h=new RegExp(d.join(""),"g"),u=g.join("+"),"generic"===s[l])throw new Error("cwise: Generic arrays not supported in combination with blocks!");t=t.replace(h,[p,"[",u,"]"].join(""))}break;case"scalar":t=t.replace(h,"Y"+a.scalarArgs.indexOf(o));break;case"index":t=t.replace(h,"index");break;case"shape":t=t.replace(h,"shape")}}}return[e.join("\n"),t,n.join("\n")].join("\n").trim()}function d(r){for(var a=new Array(r.length),s=!0,t=0;t<r.length;++t){var e=r[t],n=e.match(/\d+/);n=n?n[0]:"",0===e.charAt(0)?a[t]="u"+e.charAt(1)+n:a[t]=e.charAt(0)+n,t>0&&(s=s&&a[t]===a[t-1])}return s?a[0]:a.join("")}var g=function(r,a){for(var s=a[1].length-Math.abs(r.arrayBlockIndices[0])|0,t=new Array(r.arrayArgs.length),e=new Array(r.arrayArgs.length),n=0;n<r.arrayArgs.length;++n)e[n]=a[2*n],t[n]=a[2*n+1];var o=[],i=[],h=[],u=[],l=[];for(n=0;n<r.arrayArgs.length;++n){r.arrayBlockIndices[n]<0?(h.push(0),u.push(s),o.push(s),i.push(s+r.arrayBlockIndices[n])):(h.push(r.arrayBlockIndices[n]),u.push(r.arrayBlockIndices[n]+s),o.push(0),i.push(r.arrayBlockIndices[n]));for(var g=[],y=0;y<t[n].length;y++)h[n]<=t[n][y]&&t[n][y]<u[n]&&g.push(t[n][y]-h[n]);l.push(g)}var _=["SS"],b=["'use strict'"],m=[];for(y=0;y<s;++y)m.push(["s",y,"=SS[",y,"]"].join(""));for(n=0;n<r.arrayArgs.length;++n){_.push("a"+n),_.push("t"+n),_.push("p"+n);for(y=0;y<s;++y)m.push(["t",n,"p",y,"=t",n,"[",h[n]+y,"]"].join(""));for(y=0;y<Math.abs(r.arrayBlockIndices[n]);++y)m.push(["t",n,"b",y,"=t",n,"[",o[n]+y,"]"].join(""))}for(n=0;n<r.scalarArgs.length;++n)_.push("Y"+n);if(r.shapeArgs.length>0&&m.push("shape=SS.slice(0)"),r.indexArgs.length>0){var v=new Array(s);for(n=0;n<s;++n)v[n]="0";m.push(["index=[",v.join(","),"]"].join(""))}for(n=0;n<r.offsetArgs.length;++n){var j=r.offsetArgs[n],w=[];for(y=0;y<j.offset.length;++y)0!==j.offset[y]&&(1===j.offset[y]?w.push(["t",j.array,"p",y].join("")):w.push([j.offset[y],"*t",j.array,"p",y].join("")));0===w.length?m.push("q"+n+"=0"):m.push(["q",n,"=",w.join("+")].join(""))}var V=c([].concat(r.pre.thisVars).concat(r.body.thisVars).concat(r.post.thisVars));for((m=m.concat(V)).length>0&&b.push("var "+m.join(",")),n=0;n<r.arrayArgs.length;++n)b.push("p"+n+"|=0");r.pre.body.length>3&&b.push(p(r.pre,r,e));var A=p(r.body,r,e),k=function(r){for(var a=0,s=r[0].length;a<s;){for(var t=1;t<r.length;++t)if(r[t][a]!==r[0][a])return a;++a}return a}(l);k<s?b.push(function(r,a,s,t){for(var e=a.length,n=s.arrayArgs.length,o=s.blockSize,i=s.indexArgs.length>0,h=[],u=0;u<n;++u)h.push(["var offset",u,"=p",u].join(""));for(u=r;u<e;++u)h.push(["for(var j"+u+"=SS[",a[u],"]|0;j",u,">0;){"].join("")),h.push(["if(j",u,"<",o,"){"].join("")),h.push(["s",a[u],"=j",u].join("")),h.push(["j",u,"=0"].join("")),h.push(["}else{s",a[u],"=",o].join("")),h.push(["j",u,"-=",o,"}"].join("")),i&&h.push(["index[",a[u],"]=j",u].join(""));for(u=0;u<n;++u){for(var l=["offset"+u],c=r;c<e;++c)l.push(["j",c,"*t",u,"p",a[c]].join(""));h.push(["p",u,"=(",l.join("+"),")"].join(""))}for(h.push(f(a,s,t)),u=r;u<e;++u)h.push("}");return h.join("\n")}(k,l[0],r,A)):b.push(f(l[0],r,A)),r.post.body.length>3&&b.push(p(r.post,r,e)),r.debug&&console.log("-----Generated cwise routine for ",a,":\n"+b.join("\n")+"\n----------");var x=[r.funcName||"unnamed","_cwise_loop_",t[0].join("s"),"m",k,d(e)].join("");return new Function(["function ",x,"(",_.join(","),"){",b.join("\n"),"} return ",x].join(""))()},y=g;var _=function(r){var a=["'use strict'","var CACHED={}"],s=[],t=r.funcName+"_cwise_thunk";a.push(["return function ",t,"(",r.shimArgs.join(","),"){"].join(""));for(var e=[],n=[],o=[["array",r.arrayArgs[0],".shape.slice(",Math.max(0,r.arrayBlockIndices[0]),r.arrayBlockIndices[0]<0?","+r.arrayBlockIndices[0]+")":")"].join("")],i=[],h=[],u=0;u<r.arrayArgs.length;++u){var l=r.arrayArgs[u];s.push(["t",l,"=array",l,".dtype,","r",l,"=array",l,".order"].join("")),e.push("t"+l),e.push("r"+l),n.push("t"+l),n.push("r"+l+".join()"),o.push("array"+l+".data"),o.push("array"+l+".stride"),o.push("array"+l+".offset|0"),u>0&&(i.push("array"+r.arrayArgs[0]+".shape.length===array"+l+".shape.length+"+(Math.abs(r.arrayBlockIndices[0])-Math.abs(r.arrayBlockIndices[u]))),h.push("array"+r.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,r.arrayBlockIndices[0])+"]===array"+l+".shape[shapeIndex+"+Math.max(0,r.arrayBlockIndices[u])+"]"))}for(r.arrayArgs.length>1&&(a.push("if (!("+i.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),a.push("for(var shapeIndex=array"+r.arrayArgs[0]+".shape.length-"+Math.abs(r.arrayBlockIndices[0])+"; shapeIndex--\x3e0;) {"),a.push("if (!("+h.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),a.push("}")),u=0;u<r.scalarArgs.length;++u)o.push("scalar"+r.scalarArgs[u]);return s.push(["type=[",n.join(","),"].join()"].join("")),s.push("proc=CACHED[type]"),a.push("var "+s.join(",")),a.push(["if(!proc){","CACHED[type]=proc=compile([",e.join(","),"])}","return proc(",o.join(","),")}"].join("")),r.debug&&console.log("-----Generated thunk:\n"+a.join("\n")+"\n----------"),new Function("compile",a.join("\n"))(y.bind(void 0,r))};function b(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}var m=function(r){var a=new b;a.pre=r.pre,a.body=r.body,a.post=r.post;var s=r.args.slice(0);a.argTypes=s;for(var t=0;t<s.length;++t){var e=s[t];if("array"===e||"object"==typeof e&&e.blockIndices){if(a.argTypes[t]="array",a.arrayArgs.push(t),a.arrayBlockIndices.push(e.blockIndices?e.blockIndices:0),a.shimArgs.push("array"+t),t<a.pre.args.length&&a.pre.args[t].count>0)throw new Error("cwise: pre() block may not reference array args");if(t<a.post.args.length&&a.post.args[t].count>0)throw new Error("cwise: post() block may not reference array args")}else if("scalar"===e)a.scalarArgs.push(t),a.shimArgs.push("scalar"+t);else if("index"===e){if(a.indexArgs.push(t),t<a.pre.args.length&&a.pre.args[t].count>0)throw new Error("cwise: pre() block may not reference array index");if(t<a.body.args.length&&a.body.args[t].lvalue)throw new Error("cwise: body() block may not write to array index");if(t<a.post.args.length&&a.post.args[t].count>0)throw new Error("cwise: post() block may not reference array index")}else if("shape"===e){if(a.shapeArgs.push(t),t<a.pre.args.length&&a.pre.args[t].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(t<a.body.args.length&&a.body.args[t].lvalue)throw new Error("cwise: body() block may not write to array shape");if(t<a.post.args.length&&a.post.args[t].lvalue)throw new Error("cwise: post() block may not write to array shape")}else{if("object"!=typeof e||!e.offset)throw new Error("cwise: Unknown argument type "+s[t]);a.argTypes[t]="offset",a.offsetArgs.push({array:e.array,offset:e.offset}),a.offsetArgIndex.push(t)}}if(a.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(a.pre.args.length>s.length)throw new Error("cwise: Too many arguments in pre() block");if(a.body.args.length>s.length)throw new Error("cwise: Too many arguments in body() block");if(a.post.args.length>s.length)throw new Error("cwise: Too many arguments in post() block");return a.debug=!!r.printCode||!!r.debug,a.funcName=r.funcName||"cwise",a.blockSize=r.blockSize||64,_(a)};!function(r){var a=m,s={body:"",args:[],thisVars:[],localVars:[]};function t(r){if(!r)return s;for(var a=0;a<r.args.length;++a){var t=r.args[a];r.args[a]=0===a?{name:t,lvalue:!0,rvalue:!!r.rvalue,count:r.count||1}:{name:t,lvalue:!1,rvalue:!0,count:1}}return r.thisVars||(r.thisVars=[]),r.localVars||(r.localVars=[]),r}function e(r){for(var s=[],e=0;e<r.args.length;++e)s.push("a"+e);return new Function("P",["return function ",r.funcName,"_ndarrayops(",s.join(","),") {P(",s.join(","),");return a0}"].join(""))(function(r){return a({args:r.args,pre:t(r.pre),body:t(r.body),post:t(r.proc),funcName:r.funcName})}(r))}var n={add:"+",sub:"-",mul:"*",div:"/",mod:"%",band:"&",bor:"|",bxor:"^",lshift:"<<",rshift:">>",rrshift:">>>"};!function(){for(var a in n){var s=n[a];r[a]=e({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+s+"c"},funcName:a}),r[a+"eq"]=e({args:["array","array"],body:{args:["a","b"],body:"a"+s+"=b"},funcName:a+"eq"}),r[a+"s"]=e({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+s+"s"},funcName:a+"s"}),r[a+"seq"]=e({args:["array","scalar"],body:{args:["a","s"],body:"a"+s+"=s"},funcName:a+"seq"})}}();var o={not:"!",bnot:"~",neg:"-",recip:"1.0/"};!function(){for(var a in o){var s=o[a];r[a]=e({args:["array","array"],body:{args:["a","b"],body:"a="+s+"b"},funcName:a}),r[a+"eq"]=e({args:["array"],body:{args:["a"],body:"a="+s+"a"},funcName:a+"eq"})}}();var i={and:"&&",or:"||",eq:"===",neq:"!==",lt:"<",gt:">",leq:"<=",geq:">="};!function(){for(var a in i){var s=i[a];r[a]=e({args:["array","array","array"],body:{args:["a","b","c"],body:"a=b"+s+"c"},funcName:a}),r[a+"s"]=e({args:["array","array","scalar"],body:{args:["a","b","s"],body:"a=b"+s+"s"},funcName:a+"s"}),r[a+"eq"]=e({args:["array","array"],body:{args:["a","b"],body:"a=a"+s+"b"},funcName:a+"eq"}),r[a+"seq"]=e({args:["array","scalar"],body:{args:["a","s"],body:"a=a"+s+"s"},funcName:a+"seq"})}}();var h=["abs","acos","asin","atan","ceil","cos","exp","floor","log","round","sin","sqrt","tan"];!function(){for(var a=0;a<h.length;++a){var s=h[a];r[s]=e({args:["array","array"],pre:{args:[],body:"this_f=Math."+s,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b)",thisVars:["this_f"]},funcName:s}),r[s+"eq"]=e({args:["array"],pre:{args:[],body:"this_f=Math."+s,thisVars:["this_f"]},body:{args:["a"],body:"a=this_f(a)",thisVars:["this_f"]},funcName:s+"eq"})}}();var u=["max","min","atan2","pow"];!function(){for(var a=0;a<u.length;++a){var s=u[a];r[s]=e({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+s,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:s}),r[s+"s"]=e({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+s,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(b,c)",thisVars:["this_f"]},funcName:s+"s"}),r[s+"eq"]=e({args:["array","array"],pre:{args:[],body:"this_f=Math."+s,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},funcName:s+"eq"}),r[s+"seq"]=e({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+s,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(a,b)",thisVars:["this_f"]},funcName:s+"seq"})}}();var l=["atan2","pow"];!function(){for(var a=0;a<l.length;++a){var s=l[a];r[s+"op"]=e({args:["array","array","array"],pre:{args:[],body:"this_f=Math."+s,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:s+"op"}),r[s+"ops"]=e({args:["array","array","scalar"],pre:{args:[],body:"this_f=Math."+s,thisVars:["this_f"]},body:{args:["a","b","c"],body:"a=this_f(c,b)",thisVars:["this_f"]},funcName:s+"ops"}),r[s+"opeq"]=e({args:["array","array"],pre:{args:[],body:"this_f=Math."+s,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},funcName:s+"opeq"}),r[s+"opseq"]=e({args:["array","scalar"],pre:{args:[],body:"this_f=Math."+s,thisVars:["this_f"]},body:{args:["a","b"],body:"a=this_f(b,a)",thisVars:["this_f"]},funcName:s+"opseq"})}}(),r.any=a({args:["array"],pre:s,body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"if(a){return true}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return false"},funcName:"any"}),r.all=a({args:["array"],pre:s,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1}],body:"if(!x){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"all"}),r.sum=a({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s+=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"sum"}),r.prod=a({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=1"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:1}],body:"this_s*=a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"prod"}),r.norm2squared=a({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm2squared"}),r.norm2=a({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:2}],body:"this_s+=a*a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return Math.sqrt(this_s)"},funcName:"norm2"}),r.norminf=a({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:4}],body:"if(-a>this_s){this_s=-a}else if(a>this_s){this_s=a}",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norminf"}),r.norm1=a({args:["array"],pre:{args:[],localVars:[],thisVars:["this_s"],body:"this_s=0"},body:{args:[{name:"a",lvalue:!1,rvalue:!0,count:3}],body:"this_s+=a<0?-a:a",localVars:[],thisVars:["this_s"]},post:{args:[],localVars:[],thisVars:["this_s"],body:"return this_s"},funcName:"norm1"}),r.sup=a({args:["array"],pre:{body:"this_h=-Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_>this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),r.inf=a({args:["array"],pre:{body:"this_h=Infinity",args:[],thisVars:["this_h"],localVars:[]},body:{body:"if(_inline_1_arg0_<this_h)this_h=_inline_1_arg0_",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_h"],localVars:[]},post:{body:"return this_h",args:[],thisVars:["this_h"],localVars:[]}}),r.argmin=a({args:["index","array","shape"],pre:{body:"{this_v=Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_<this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),r.argmax=a({args:["index","array","shape"],pre:{body:"{this_v=-Infinity;this_i=_inline_0_arg2_.slice(0)}",args:[{name:"_inline_0_arg0_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg1_",lvalue:!1,rvalue:!1,count:0},{name:"_inline_0_arg2_",lvalue:!1,rvalue:!0,count:1}],thisVars:["this_i","this_v"],localVars:[]},body:{body:"{if(_inline_1_arg1_>this_v){this_v=_inline_1_arg1_;for(var _inline_1_k=0;_inline_1_k<_inline_1_arg0_.length;++_inline_1_k){this_i[_inline_1_k]=_inline_1_arg0_[_inline_1_k]}}}",args:[{name:"_inline_1_arg0_",lvalue:!1,rvalue:!0,count:2},{name:"_inline_1_arg1_",lvalue:!1,rvalue:!0,count:2}],thisVars:["this_i","this_v"],localVars:["_inline_1_k"]},post:{body:"{return this_i}",args:[],thisVars:["this_i"],localVars:[]}}),r.random=e({args:["array"],pre:{args:[],body:"this_f=Math.random",thisVars:["this_f"]},body:{args:["a"],body:"a=this_f()",thisVars:["this_f"]},funcName:"random"}),r.assign=e({args:["array","array"],body:{args:["a","b"],body:"a=b"},funcName:"assign"}),r.assigns=e({args:["array","scalar"],body:{args:["a","b"],body:"a=b"},funcName:"assigns"}),r.equals=a({args:["array","array"],pre:s,body:{args:[{name:"x",lvalue:!1,rvalue:!0,count:1},{name:"y",lvalue:!1,rvalue:!0,count:1}],body:"if(x!==y){return false}",localVars:[],thisVars:[]},post:{args:[],localVars:[],thisVars:[],body:"return true"},funcName:"equals"})}(l);var v=r(l);let j,w,V,A=!1,k=null;const x=document.createElement("canvas");x.width=128,x.height=128;const I=x.getContext("2d",{willReadFrequently:!0}),M=document.createElement("canvas");M.width=128,M.height=128;const N=M.getContext("2d",{willReadFrequently:!0});function q(r,a,s,t){w=r,k=function(r,a=null){return k||(k=new Worker(new URL("worker-B_a3yASh.js",import.meta.url),{type:"module"}),k.onmessage=s=>{const{type:t,error:e,...n}=s.data;if(!e)return"modelLoaded"===t?(console.log('ℹ️ Received "modelLoaded" from worker'),void(a&&a())):void("modelLoadFailed"!==t?r&&r(n):console.error("⚠️ Model failed to load inside worker"));console.error("Worker error:",e)},k)}(t,()=>{console.log("👁️ Model loaded inside worker, calling onReady"),s&&s()}),V=new window.FaceMesh({locateFile:r=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4/${r}`}),V.setOptions({selfieMode:!0,refineLandmarks:!0,maxNumFaces:1,minDetectionConfidence:.5,minTrackingConfidence:.5}),V.onResults(E),w.addEventListener("play",()=>{A=!0})}function E(r){if(!r.multiFaceLandmarks||0===r.multiFaceLandmarks.length)return;const a=r.multiFaceLandmarks[0],s=w.videoWidth,t=w.videoHeight,e=[],n=[];if(C(a,[130,27,243,23],e),C(a,[463,257,359,253],n),0===e.length||0===n.length)return;let[o,i,h,l]=B(e,s,t);const c=[o/s,i/t,h/s,l/t];I.drawImage(w,Math.max(0,s-o-h),Math.max(0,i),Math.max(0,h),Math.max(0,l),0,0,128,128),[o,i,h,l]=B(n,s,t),c.push(o/s,i/t,h/s,l/t),N.drawImage(w,Math.max(0,s-o-h),Math.max(0,i),Math.max(0,h),Math.max(0,l),0,0,128,128);let f=F(I.getImageData(0,0,128,128).data,128,128);let p=F(N.getImageData(0,0,128,128).data,128,128),d=function(r){const a=u(new Float32Array(r),[r.length]),s=u(new Float32Array(r.length),[1,r.length]);return v.assign(s.pick(0,null),a),new Float32Array(s.data)}(c);k.postMessage({input1:{data:f},input2:{data:p},kpsTensor:{data:d}})}function F(r,a,s){const t=u(new Float32Array(r),[a,s,4]),e=u(new Float32Array(a*s*3),[1,3,s,a]);return v.divseq(t,255),v.assign(e.pick(0,0,null,null),t.pick(null,null,2)),v.assign(e.pick(0,1,null,null),t.pick(null,null,1)),v.assign(e.pick(0,2,null,null),t.pick(null,null,0)),new Float32Array(e.data)}function B(r,a,s){let t=(r[0][0]+r[2][0])/2,e=(r[1][1]+r[3][1])/2,n=r[2][0]-r[0][0],o=r[3][1]-r[1][1],i=[t,e,n,o];return n=i[2]*a,o=i[3]*s,[(i[0]-i[2]/2)*a,(i[1]-i[3]/2)*s,n,o]}function C(r,a,s){a.forEach(a=>{const t=r[a];s.push([t.x,t.y])})}let T=!1;function O({containerId:r=null,video:a=null,canvas:s=null,hide:t=!0,onReady:e=null,onGaze:n=null}={}){const o=r?document.getElementById(r):document.body;a||((a=document.createElement("video")).className="inputVideo",a.autoplay=!0,a.playsInline=!0,t&&(a.style.display="none"),o.appendChild(a)),s||((s=document.createElement("canvas")).id="headCanvas",t&&(s.style.display="none"),o.appendChild(s)),console.log("initialising ..."),navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(r=>{a.srcObject=r,q(a,0,()=>{T=!0,console.log("initialised, ready to run eyetracking"),e&&e()},n)})}function R(){T?(A=!0,async function r(){A&&(await V.send({image:w}),j=requestAnimationFrame(r))}()):console.warn("Eye tracking has not been initialized. Call initEyeTracking() first.")}function S(){A=!1,null!==j&&(cancelAnimationFrame(j),j=null)}export{O as initEyeTracking,R as runEyeTracking,S as stopEyeTracking};
//# sourceMappingURL=index.js.map
